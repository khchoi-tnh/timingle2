-- timingle Keyspace (Discord-level í™•ì¥ì„±)
-- ê°œë°œ í™˜ê²½: SimpleStrategy ì‚¬ìš©
CREATE KEYSPACE IF NOT EXISTS timingle
  WITH replication = {
    'class': 'SimpleStrategy',
    'replication_factor': 1
  }
  AND durable_writes = true;

USE timingle;

-- 1. ì±„íŒ… ë©”ì‹œì§€ (ì´ë²¤íŠ¸ë³„)
CREATE TABLE IF NOT EXISTS chat_messages_by_event (
  event_id BIGINT,              -- Partition Key
  created_at TIMESTAMP,         -- Clustering Key 1
  message_id UUID,              -- Clustering Key 2
  sender_id BIGINT,
  sender_name TEXT,
  sender_profile_url TEXT,
  message TEXT,
  message_type TEXT,            -- 'text', 'system', 'image'
  attachments LIST<TEXT>,
  reply_to UUID,
  edited_at TIMESTAMP,
  is_deleted BOOLEAN,
  metadata MAP<TEXT, TEXT>,
  PRIMARY KEY ((event_id), created_at, message_id)
) WITH CLUSTERING ORDER BY (created_at ASC, message_id ASC)
  AND compaction = {
    'class': 'TimeWindowCompactionStrategy',
    'compaction_window_size': 1,
    'compaction_window_unit': 'DAYS'
  }
  AND gc_grace_seconds = 86400
  AND caching = {'keys': 'ALL', 'rows_per_partition': '100'};

-- 2. ì´ë²¤íŠ¸ íˆìŠ¤í† ë¦¬ (ë³€ê²½ ë¡œê·¸)
CREATE TABLE IF NOT EXISTS event_history (
  event_id BIGINT,
  changed_at TIMESTAMP,
  change_id UUID,
  actor_id BIGINT,
  actor_name TEXT,
  change_type TEXT,             -- 'CREATED', 'UPDATED', 'CONFIRMED', 'CANCELED'
  field_name TEXT,              -- ë³€ê²½ëœ í•„ë“œ
  old_value TEXT,
  new_value TEXT,
  metadata MAP<TEXT, TEXT>,
  PRIMARY KEY ((event_id), changed_at, change_id)
) WITH CLUSTERING ORDER BY (changed_at DESC, change_id DESC)
  AND compaction = {'class': 'SizeTieredCompactionStrategy'}
  AND gc_grace_seconds = 864000; -- 10ì¼ (ë…¸ì‡¼ ì¦ê±° ë³´ê´€)

-- 3. ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´í„°
CREATE TABLE IF NOT EXISTS unread_message_counts (
  event_id BIGINT,
  user_id BIGINT,
  count COUNTER,
  PRIMARY KEY ((event_id, user_id))
);

-- 4. íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° (TTL 10ì´ˆ)
CREATE TABLE IF NOT EXISTS typing_indicators (
  event_id BIGINT,
  user_id BIGINT,
  user_name TEXT,
  started_at TIMESTAMP,
  PRIMARY KEY ((event_id), user_id)
) WITH default_time_to_live = 10;

-- 5. ë©”ì‹œì§€ ë°˜ì‘ (ì¢‹ì•„ìš”, ì´ëª¨ì§€)
CREATE TABLE IF NOT EXISTS message_reactions (
  message_id UUID,
  user_id BIGINT,
  reaction TEXT,                -- 'ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', etc.
  created_at TIMESTAMP,
  PRIMARY KEY ((message_id), user_id)
);

-- 6. ì‚¬ìš©ìë³„ ì±„íŒ… ë©”ì‹œì§€ ì¸ë±ìŠ¤ (ì„ íƒì , ì‚¬ìš©ì í™œë™ ì¶”ì )
CREATE TABLE IF NOT EXISTS chat_messages_by_user (
  user_id BIGINT,
  created_at TIMESTAMP,
  event_id BIGINT,
  message_id UUID,
  PRIMARY KEY ((user_id), created_at, event_id)
) WITH CLUSTERING ORDER BY (created_at DESC, event_id ASC);
